# -*- coding: utf-8 -*-
"""
发票信息提取 Prompt 模板

用于构建发送给大模型的提示词
"""

# 发票信息提取主Prompt
INVOICE_EXTRACTION_PROMPT = """你是一位专业的发票信息提取专家。请从以下发票内容中提取关键信息。

## 发票内容
```
{invoice_text}
```

## 请严格按照以下JSON格式返回提取结果：

```json
{{
    "发票号码": "20位数字或8位数字，如无法识别填null",
    "发票类型": "增值税电子普通发票/增值税专用发票/增值税普通发票/机动车销售统一发票/火车票/飞机行程单/出租车票/其他",
    "开票日期": "YYYY-MM-DD格式，如无法识别填null",
    "购买方名称": "完整公司名称",
    "购买方纳税人识别号": "15-20位统一社会信用代码/纳税人识别号",
    "销售方名称": "完整公司名称",
    "销售方纳税人识别号": "15-20位统一社会信用代码/纳税人识别号",
    "金额": "不含税金额数字",
    "税额": "税额数字",
    "价税合计": "含税总金额数字",
    "发票内容": "商品或服务名称，如：服务费、材料费、运输费等",
    "备注": "发票备注信息，如无则填null"
}}
```

## 重要提示：
1. 发票号码通常是20位（电子发票）或8位（纸质发票）纯数字
2. 纳税人识别号是15-20位的数字字母组合，通常以9开头
3. 金额只保留数字，不含货币符号￥或¥
4. 如遇模糊内容，请根据上下文合理推断
5. 严格返回JSON格式，不要添加其他解释文字
6. 如果备注栏包含"代开企业名称"、"代开人"等信息，请提取真实销售方：
    - 优先提取备注中的代开企业名称作为销售方
    - 如果代开信息格式为"代开人+业务描述"（如"谢强、门润搭设与拆除劳务"），
    仅提取代开人姓名或企业名称作为销售方"""


# 视觉识别Prompt（用于图片发票）
INVOICE_VISION_PROMPT = """请仔细观察这张发票图片，提取以下关键信息。

## 请严格按照以下JSON格式返回提取结果：

```json
{{
    "发票号码": "20位或8位数字",
    "发票类型": "发票类型名称",
    "开票日期": "YYYY-MM-DD",
    "购买方名称": "完整公司名称",
    "购买方纳税人识别号": "税号",
    "销售方名称": "完整公司名称",
    "销售方纳税人识别号": "税号",
    "金额": "不含税金额",
    "税额": "税额",
    "价税合计": "含税总额",
    "发票内容": "商品或服务名称",
    "备注": "备注信息或null"
}}
```

## 特别注意事项：

### 1. 销售方名称识别规则
- **销售方名称**必须是完整的公司/企业全称（如：XX有限公司、XX个体工商户）
- **不要**提取地址、电话号码、税务局名称作为销售方
- 如果发票由税务局代开，销售方应该是实际提供商品/服务的企业或个人，通常在**备注栏**
- 示例错误：❌ "武汉市洪山区流芳街道红旗村大彭湾15972178865"（这是地址+电话）
- 示例正确：✅ "武汉东湖新技术开发区江波预制厂"（这是公司名）

### 2. 代开发票特殊处理
- 如果发票抬头显示为"XX税务局"或"税务所"，这是**代开发票**
- 请在**备注栏**查找实际销售方信息（通常有"代开人"、"代开企业"字样）
- 将备注栏中的实际销售方填入"销售方名称"字段
- 将税务局信息填入"备注"字段

### 3. 其他要求
- 仔细识别图片中的所有文字信息
- 注意区分购买方和销售方信息
- 发票号码通常在发票右上角或顶部
- 金额信息通常在表格下方
- 严格返回JSON格式，不要添加其他解释"""


# 发票类型识别Prompt（轻量级）
INVOICE_TYPE_PROMPT = """请识别以下发票内容属于哪种发票类型：

内容：{invoice_text}

可选类型：
- 增值税电子普通发票
- 增值税专用发票  
- 增值税普通发票
- 机动车销售统一发票
- 火车票
- 飞机行程单
- 出租车票
- 过路过桥费发票
- 停车费发票
- 酒店住宿发票
- 餐饮发票
- 其他

请只返回发票类型名称，不要添加其他内容。"""


def build_extraction_prompt(invoice_text: str) -> str:
    """构建发票信息提取Prompt"""
    return INVOICE_EXTRACTION_PROMPT.format(invoice_text=invoice_text)


def build_vision_prompt() -> str:
    """构建视觉识别Prompt"""
    return INVOICE_VISION_PROMPT


def build_type_prompt(invoice_text: str) -> str:
    """构建类型识别Prompt"""
    return INVOICE_TYPE_PROMPT.format(invoice_text=invoice_text[:500])  # 限制长度
